<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cuotavista | Analizá tu Estado de Cuenta</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='cuotavista-logo-ojo-transparent.png') }}">
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y42CJ54H0Z"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Y42CJ54H0Z');
  </script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cream: {
              base: '#F4F1EC',
              light: '#FAF8F5',
              dark: '#E8E4DD',
            },
            olive: {
              DEFAULT: '#6B7F5A',
              dark: '#3F4F3C',
              soft: '#A8B79A',
              hover: '#5A6D4A',
            },
            text: {
              primary: '#2E2E2E',
              secondary: '#6B6B6B',
              disabled: '#9A9A9A',
            },
            state: {
              success: '#6E8F6A',
              warning: '#C2A24D',
              error: '#9B4A3C',
            }
          }
        }
      }
    }
  </script>

  <style>
    .upload-zone {
      transition: all 0.2s ease;
    }
    .upload-zone:hover {
      border-color: #6B7F5A;
    }
    .upload-zone.dragover {
      border-color: #6B7F5A;
      background-color: #f0f3ed;
    }
    .upload-zone.processing {
      opacity: 0.7;
      pointer-events: none;
    }
    .error-message {
      animation: shake 0.4s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    /* Modal animations */
    @keyframes fade-in {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .animate-fade-in {
      animation: fade-in 0.2s ease-out forwards;
    }
    /* Spinner animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</head>

<body class="bg-cream-base text-text-primary antialiased">

    <!-- Header inicial (NO sticky) -->
    <header class="bg-olive-dark/5 border-b border-cream-dark/40">
      <div class="h-[14vh] min-h-[100px] max-h-[140px] flex items-center justify-center px-6">
        <a href="/" class="flex items-center">
          <img src="{{ url_for('static', filename='cuotavista-high-resolution-logo.png') }}" alt="Cuotavista" class="h-12 md:h-16">
        </a>
      </div>
    </header>

    <!-- SVG ondulado sutil -->
    <div class="w-full overflow-hidden bg-olive-dark/5">
      <svg class="w-full h-8 md:h-10" viewBox="0 0 1200 40" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M0,20 C200,35 400,5 600,20 C800,35 1000,5 1200,20 L1200,40 L0,40 Z" fill="#FAF8F5" opacity="0.8"/>
      </svg>
    </div>

  <!-- Acción: Subir archivo (protagonista, above the fold) -->
  <section id="analizar" class="bg-cream-light py-12 md:py-16 px-6">
    <div class="max-w-4xl mx-auto">
      
      <h2 class="text-2xl md:text-4xl font-bold text-center text-text-primary mb-3">
        Analizá tu estado de cuenta
      </h2>
      <p class="text-text-secondary text-center mb-8">
        Elegí tu banco y subí el archivo.
      </p>

      <!-- Formularios -->
      <div class="grid md:grid-cols-3 gap-6">
        
        <!-- BROU -->
        <form 
          id="form-brou"
          action="/brou/resultado" 
          method="POST" 
          enctype="multipart/form-data"
          class="upload-zone bg-cream-light border border-cream-dark rounded-xl p-6 md:p-8 text-center">
          
          <div class="mb-5">
            <h3 class="text-lg font-semibold text-text-primary">BROU</h3>
            <p class="text-sm text-text-secondary mt-1">Excel (.xls o .xlsx)</p>
            <a href="{{ url_for('static', filename='ejemplo_estado_cuenta.xls') }}" download class="text-xs text-olive hover:text-olive-dark underline mt-2 inline-block">Ver ejemplo</a>
          </div>
          
          <input 
            type="file" 
            name="file" 
            id="file-brou"
            accept=".xls,.xlsx" 
            required
            class="hidden">
          
          <label 
            for="file-brou" 
            class="inline-flex items-center gap-2 bg-olive text-white px-6 py-3 rounded-lg font-medium hover:bg-olive-dark transition cursor-pointer">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            Subir archivo
          </label>

          <!-- Área de error -->
          <div id="error-brou" class="hidden mt-4 p-3 bg-state-error/10 border border-state-error/30 rounded-lg text-sm text-state-error"></div>
        </form>

        <!-- Itaú -->
        <form 
          id="form-itau"
          action="/itau/resultado" 
          method="POST" 
          enctype="multipart/form-data"
          class="upload-zone bg-cream-light border border-cream-dark rounded-xl p-6 md:p-8 text-center">
          
          <div class="mb-5">
            <h3 class="text-lg font-semibold text-text-primary">Itaú</h3>
            <p class="text-sm text-text-secondary mt-1">PDF del estado de cuenta</p>
          </div>
          
          <input 
            type="file" 
            name="archivo" 
            id="file-itau"
            accept=".pdf" 
            required
            class="hidden">
          
          <label 
            for="file-itau" 
            class="inline-flex items-center gap-2 bg-olive text-white px-6 py-3 rounded-lg font-medium hover:bg-olive-dark transition cursor-pointer">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            Subir archivo
          </label>

          <!-- Área de error -->
          <div id="error-itau" class="hidden mt-4 p-3 bg-state-error/10 border border-state-error/30 rounded-lg text-sm text-state-error"></div>
        </form>

        <!-- Santander -->
        <div 
          id="zone-santander"
          class="upload-zone relative bg-cream-light border border-cream-dark rounded-xl p-6 md:p-8 text-center">
          <!-- Badge En pruebas (top-right) -->
          <div class="absolute top-3 right-3">
            <span class="inline-flex items-center px-2.5 py-1 text-[11px] font-semibold rounded-full border border-gray-200" style="color:#6b7280; background:#f4f5f1;">
              En pruebas
            </span>
          </div>
          
          <div class="mb-5">
            <h3 class="text-lg font-semibold text-text-primary">Santander</h3>
            <p class="text-sm text-text-secondary mt-1">PDF del estado de cuenta</p>
          </div>
          
          <input 
            type="file" 
            id="file-santander"
            accept=".pdf"
            class="hidden">
          
          <label 
            for="file-santander" 
            id="label-santander"
            class="inline-flex items-center gap-2 bg-olive text-white px-6 py-3 rounded-lg font-medium hover:bg-olive-dark transition cursor-pointer">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            <span id="santander-btn-text">Subir archivo</span>
          </label>

          <!-- Estado de procesamiento -->
          <p id="santander-status" class="hidden mt-4 text-sm text-text-secondary"></p>
        </div>

      </div>

      <!-- Disclaimer -->
      <div class="mt-10 max-w-2xl mx-auto text-center">
        <p class="text-sm text-text-secondary leading-relaxed">
          No se guarda tu información. El código es open-source y puede ser auditado.
        </p>
      </div>
    </div>
  </section>

  <!-- MODAL: Contraseña Santander -->
  <div id="modal-password" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="bg-cream-light rounded-2xl shadow-xl p-8 w-full max-w-md mx-4 animate-fade-in">
      <h3 class="text-xl font-semibold text-text-primary text-center mb-2">Contraseña del PDF</h3>
      <p class="text-sm text-text-secondary text-center mb-6">El archivo está protegido.</p>
      
      <div class="relative mb-4">
        <input 
          type="password" 
          id="modal-password-input"
          placeholder="Contraseña"
          class="w-full px-4 py-3 border border-cream-dark rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-olive/50 focus:border-olive text-lg">
        <button 
          type="button"
          id="modal-toggle-password"
          class="absolute right-3 top-1/2 transform -translate-y-1/2 text-text-secondary hover:text-text-primary"
          title="Mostrar/ocultar contraseña">
          <svg id="modal-eye-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </button>
      </div>

      <p class="text-xs text-text-secondary text-center mb-6">
        La contraseña no se guarda. Se usa solo en memoria para desencriptar el archivo.
      </p>

      <!-- Error dentro del modal -->
      <div id="modal-password-error" class="hidden mb-4 p-3 bg-state-error/10 border border-state-error/30 rounded-lg text-sm text-state-error text-center"></div>

      <div class="flex gap-3">
        <button 
          type="button"
          id="modal-cancel-btn"
          class="flex-1 px-4 py-3 border border-cream-dark rounded-lg text-text-secondary hover:bg-cream-dark/50 transition">
          Cancelar
        </button>
        <button 
          type="button"
          id="modal-submit-btn"
          class="flex-1 px-4 py-3 bg-olive text-white rounded-lg font-medium hover:bg-olive-dark transition flex items-center justify-center gap-2">
          <span>Continuar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: Error genérico -->
  <div id="modal-error" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="bg-cream-light rounded-2xl shadow-xl p-8 w-full max-w-md mx-4 animate-fade-in">
      <div class="text-center mb-6">
        <div class="w-16 h-16 mx-auto mb-4 bg-state-error/10 rounded-full flex items-center justify-center">
          <svg class="w-8 h-8 text-state-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
        </div>
        <h3 class="text-xl font-semibold text-text-primary mb-2">No se pudo procesar</h3>
        <p id="modal-error-message" class="text-sm text-text-secondary"></p>
      </div>
      
      <button 
        type="button"
        id="modal-error-close"
        class="w-full px-4 py-3 bg-olive text-white rounded-lg font-medium hover:bg-olive-dark transition">
        Entendido
      </button>
    </div>
  </div>

  <!-- Video explicativo (sección secundaria) -->
  <section class="bg-cream-base py-20 px-6 border-t border-cream-dark/20">
    <div class="max-w-2xl mx-auto">
      <h2 class="text-xl md:text-2xl font-semibold text-center text-olive-dark mb-8">¿Cómo funciona?</h2>
      <div class="w-full aspect-video rounded-xl overflow-hidden">
        <iframe 
          class="w-full h-full"
          src="https://www.youtube.com/embed/wxCg8nTXSa0" 
          title="Cómo usar Cuotavista"
          frameborder="0" 
          allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
          referrerpolicy="strict-origin-when-cross-origin"
          allowfullscreen>
        </iframe>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-cream-dark border-t border-olive-dark/10 py-14 px-6">
    <div class="max-w-3xl mx-auto space-y-6">
      <p class="text-sm text-text-secondary text-center">
        Creado por <a href="https://www.linkedin.com/in/hdemello/" target="_blank" rel="noopener noreferrer" class="text-olive hover:text-olive-dark transition underline">Henry de Mello</a>
      </p>
      <div class="flex items-center justify-center gap-8 text-sm text-text-secondary">
        <a href="mailto:cuotavista@gmail.com" class="hover:text-olive-dark transition">Contacto</a>
        <a href="https://github.com/absterben/cuotavista" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 hover:text-olive-dark transition">
          <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38C13.71 14.53 16 11.54 16 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
          <span>Ver código fuente en GitHub</span>
        </a>
      </div>
      <p class="text-xs text-text-disabled text-center leading-relaxed">
        Herramienta independiente. No afiliada con ninguna institución financiera.
        <br>
        El análisis puede no ser exacto, se recomienda corroborar siempre la información.
      </p>
    </div>
  </footer>

  <!-- JavaScript para Drag & Drop -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      // Configuración de cada zona de carga (BROU e Itaú - formularios tradicionales)
      const zones = [
        {
          formId: 'form-brou',
          inputId: 'file-brou',
          errorId: 'error-brou',
          allowedExtensions: ['.xls', '.xlsx'],
          dragoverClass: 'dragover',
          errorMessages: {
            wrongType: 'El archivo debe ser un Excel (.xls o .xlsx) de BROU',
            empty: 'El archivo está vacío',
            generic: 'No se pudo leer el archivo'
          }
        },
        {
          formId: 'form-itau',
          inputId: 'file-itau',
          errorId: 'error-itau',
          allowedExtensions: ['.pdf'],
          dragoverClass: 'dragover',
          errorMessages: {
            wrongType: 'El archivo debe ser un PDF de Itaú',
            empty: 'El archivo está vacío',
            generic: 'No se pudo leer el archivo'
          }
        }
      ];

      zones.forEach(zone => {
        const form = document.getElementById(zone.formId);
        const input = document.getElementById(zone.inputId);
        const errorDiv = document.getElementById(zone.errorId);

        // Prevenir comportamiento por defecto en todo el documento
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          form.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        // Feedback visual al arrastrar
        ['dragenter', 'dragover'].forEach(eventName => {
          form.addEventListener(eventName, () => {
            form.classList.add(zone.dragoverClass);
            hideError(errorDiv);
          });
        });

        ['dragleave', 'drop'].forEach(eventName => {
          form.addEventListener(eventName, () => {
            form.classList.remove(zone.dragoverClass);
          });
        });

        // Manejar el drop
        form.addEventListener('drop', (e) => {
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFile(files[0], zone, input, form, errorDiv);
          }
        });

        // Manejar selección por input (botón)
        input.addEventListener('change', () => {
          if (input.files.length > 0) {
            handleFile(input.files[0], zone, input, form, errorDiv);
          }
        });
      });

      function handleFile(file, zone, input, form, errorDiv) {
        // Validar extensión
        const fileName = file.name.toLowerCase();
        const hasValidExtension = zone.allowedExtensions.some(ext => fileName.endsWith(ext));
        
        if (!hasValidExtension) {
          showError(errorDiv, zone.errorMessages.wrongType);
          return;
        }

        // Validar que no esté vacío
        if (file.size === 0) {
          showError(errorDiv, zone.errorMessages.empty);
          return;
        }

        // Validar tamaño mínimo razonable (al menos 100 bytes)
        if (file.size < 100) {
          showError(errorDiv, 'El archivo parece estar corrupto o incompleto');
          return;
        }

        // Todo OK - asignar archivo al input y enviar
        hideError(errorDiv);
        
        // Crear DataTransfer para asignar el archivo al input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        input.files = dataTransfer.files;

        // Mostrar estado de procesamiento
        form.classList.add('processing');
        
        // Enviar formulario
        form.submit();
      }

      function showError(errorDiv, message) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        errorDiv.classList.add('error-message');
        
        // Quitar animación después de que termine
        setTimeout(() => {
          errorDiv.classList.remove('error-message');
        }, 400);
      }

      function hideError(errorDiv) {
        errorDiv.classList.add('hidden');
        errorDiv.textContent = '';
      }

      // ========================================
      // SANTANDER - Auto-análisis con temp_id
      // ========================================
      
      const santanderZone = document.getElementById('zone-santander');
      const santanderInput = document.getElementById('file-santander');
      const santanderLabel = document.getElementById('label-santander');
      const santanderBtnText = document.getElementById('santander-btn-text');
      const santanderStatus = document.getElementById('santander-status');
      
      // Modal de contraseña
      const modalPassword = document.getElementById('modal-password');
      const modalPasswordInput = document.getElementById('modal-password-input');
      const modalPasswordError = document.getElementById('modal-password-error');
      const modalCancelBtn = document.getElementById('modal-cancel-btn');
      const modalSubmitBtn = document.getElementById('modal-submit-btn');
      const modalTogglePassword = document.getElementById('modal-toggle-password');
      const modalEyeIcon = document.getElementById('modal-eye-icon');
      
      // Modal de error
      const modalError = document.getElementById('modal-error');
      const modalErrorMessage = document.getElementById('modal-error-message');
      const modalErrorClose = document.getElementById('modal-error-close');

      // Estado
      let santanderFile = null;
      let pendingTempId = null;
      let isProcessing = false;

      // Toggle password visibility
      modalTogglePassword.addEventListener('click', () => {
        const isPassword = modalPasswordInput.type === 'password';
        modalPasswordInput.type = isPassword ? 'text' : 'password';
        modalEyeIcon.innerHTML = isPassword 
          ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />'
          : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
      });

      // Drag & Drop para Santander
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        santanderZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        }, false);
      });

      ['dragenter', 'dragover'].forEach(eventName => {
        santanderZone.addEventListener(eventName, () => {
          santanderZone.classList.add('dragover');
        });
      });

      ['dragleave', 'drop'].forEach(eventName => {
        santanderZone.addEventListener(eventName, () => {
          santanderZone.classList.remove('dragover');
        });
      });

      santanderZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleSantanderFile(files[0]);
        }
      });

      santanderInput.addEventListener('change', () => {
        if (santanderInput.files.length > 0) {
          handleSantanderFile(santanderInput.files[0]);
        }
      });

      function handleSantanderFile(file) {
        const fileName = file.name.toLowerCase();
        
        if (!fileName.endsWith('.pdf')) {
          showErrorModal('El archivo debe ser un PDF.');
          return;
        }

        if (file.size === 0 || file.size < 100) {
          showErrorModal('El archivo está vacío o corrupto.');
          return;
        }

        // Guardar archivo y auto-enviar
        santanderFile = file;
        uploadSantander();
      }

      // Auto-upload al seleccionar archivo
      async function uploadSantander() {
        if (isProcessing || !santanderFile) return;
        isProcessing = true;
        
        setLoadingState(true, 'Analizando...');

        const formData = new FormData();
        formData.append('archivo', santanderFile);

        try {
          const response = await fetch('/santander/upload', {
            method: 'POST',
            body: formData
          });

          const contentType = response.headers.get('content-type');
          
          if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            
            if (data.needs_password) {
              // Guardar temp_id y mostrar modal de contraseña
              pendingTempId = data.temp_id;
              showPasswordModal();
            } else if (data.error_type === 'invalid_password') {
              showPasswordModal(data.message);
            } else {
              showErrorModal(data.message || 'Error al procesar el archivo.');
            }
          } else {
            // HTML -> éxito
            const html = await response.text();
            document.open();
            document.write(html);
            document.close();
          }
        } catch (error) {
          showErrorModal('Error de conexión. Intentá de nuevo.');
        } finally {
          isProcessing = false;
          setLoadingState(false);
        }
      }

      // Enviar con contraseña
      async function submitWithPassword(password) {
        if (isProcessing || !pendingTempId) return;
        isProcessing = true;
        
        setModalLoadingState(true);

        const formData = new FormData();
        formData.append('temp_id', pendingTempId);
        formData.append('password', password);

        try {
          const response = await fetch('/santander/process-with-password', {
            method: 'POST',
            body: formData
          });

          const contentType = response.headers.get('content-type');
          
          if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            
            if (data.error_type === 'invalid_password') {
              // Mostrar error en el modal
              modalPasswordError.textContent = data.message || 'Contraseña incorrecta.';
              modalPasswordError.classList.remove('hidden');
            } else if (data.error_type === 'expired') {
              hidePasswordModal();
              showErrorModal(data.message);
              pendingTempId = null;
            } else {
              hidePasswordModal();
              showErrorModal(data.message || 'Error al procesar.');
            }
          } else {
            // HTML -> éxito
            const html = await response.text();
            document.open();
            document.write(html);
            document.close();
          }
        } catch (error) {
          hidePasswordModal();
          showErrorModal('Error de conexión.');
        } finally {
          isProcessing = false;
          setModalLoadingState(false);
        }
      }

      function setLoadingState(loading, text = '') {
        if (loading) {
          santanderZone.classList.add('processing');
          santanderBtnText.textContent = text || 'Procesando...';
          santanderLabel.classList.add('pointer-events-none', 'opacity-70');
        } else {
          santanderZone.classList.remove('processing');
          santanderBtnText.textContent = 'Subir archivo';
          santanderLabel.classList.remove('pointer-events-none', 'opacity-70');
          santanderFile = null;
          santanderInput.value = '';
        }
      }

      function setModalLoadingState(loading) {
        if (loading) {
          modalSubmitBtn.disabled = true;
          modalSubmitBtn.innerHTML = `
            <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          `;
        } else {
          modalSubmitBtn.disabled = false;
          modalSubmitBtn.innerHTML = '<span>Continuar</span>';
        }
      }

      // Modal de contraseña
      function showPasswordModal(errorMsg = null) {
        modalPassword.classList.remove('hidden');
        modalPassword.classList.add('flex');
        modalPasswordInput.value = '';
        modalPasswordInput.type = 'password';
        modalPasswordInput.focus();
        
        if (errorMsg) {
          modalPasswordError.textContent = errorMsg;
          modalPasswordError.classList.remove('hidden');
        } else {
          modalPasswordError.classList.add('hidden');
        }
      }

      function hidePasswordModal() {
        modalPassword.classList.add('hidden');
        modalPassword.classList.remove('flex');
        modalPasswordError.classList.add('hidden');
        setLoadingState(false);
      }

      modalCancelBtn.addEventListener('click', () => {
        hidePasswordModal();
        pendingTempId = null;
      });
      
      modalPassword.addEventListener('click', (e) => {
        if (e.target === modalPassword) {
          hidePasswordModal();
          pendingTempId = null;
        }
      });

      modalSubmitBtn.addEventListener('click', () => {
        const password = modalPasswordInput.value;
        if (!password.trim()) {
          modalPasswordError.textContent = 'Ingresá la contraseña.';
          modalPasswordError.classList.remove('hidden');
          return;
        }
        modalPasswordError.classList.add('hidden');
        submitWithPassword(password);
      });

      modalPasswordInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          modalSubmitBtn.click();
        }
      });

      // Modal de error
      function showErrorModal(message) {
        modalErrorMessage.textContent = message;
        modalError.classList.remove('hidden');
        modalError.classList.add('flex');
        setLoadingState(false);
      }

      function hideErrorModal() {
        modalError.classList.add('hidden');
        modalError.classList.remove('flex');
      }

      modalErrorClose.addEventListener('click', hideErrorModal);
      
      modalError.addEventListener('click', (e) => {
        if (e.target === modalError) hideErrorModal();
      });

      // ESC para cerrar modales
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (!modalPassword.classList.contains('hidden')) {
            hidePasswordModal();
            pendingTempId = null;
          }
          hideErrorModal();
        }
      });

    });
  </script>

</body>
</html>
